<!DOCTYPE html>
<html>
<head>
  <title>Video Stream Test</title>
  <style>
    video {
      width: 300px;
      border: 2px solid #444;
      border-radius: 8px;
    }
  </style>
</head>

<body>

<h2>Video Stream to Backend</h2>

<video id="preview" autoplay playsinline></video>
<br><br>

<button id="start">Start Video Stream</button>
<button id="stop">Stop Video Stream</button>

<script>
let ws = null;
let mediaRecorder = null;
let stream = null;

async function waitForWSOpen(socket) {
    return new Promise(resolve => {
        if (socket.readyState === WebSocket.OPEN) {
            resolve();
        } else {
            socket.addEventListener("open", () => resolve());
        }
    });
}

document.getElementById("start").onclick = async () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
        console.log("WebSocket already open");
        return;
    }

    ws = new WebSocket("ws://127.0.0.1:8000/stream/video/demo-session");
    ws.binaryType = "arraybuffer";

    ws.onopen = () => console.log("WS opened");
    ws.onclose = () => console.log("WS closed");
    ws.onerror = (err) => console.log("WS error:", err);
    ws.onmessage = (msg) => console.log("Server:", msg.data);

    await waitForWSOpen(ws);
    console.log("WS is ready, starting camera");

    // Get camera
    stream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: false
    });

    document.getElementById("preview").srcObject = stream;

    mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

    mediaRecorder.ondataavailable = async (e) => {
        const buf = await e.data.arrayBuffer();

        if (!ws || ws.readyState !== WebSocket.OPEN) {
            console.warn("WS not open, dropping video chunk");
            return;
        }

        ws.send(buf);
    };

    console.log("Recording started");
    mediaRecorder.start(300);   // send chunk every 300ms
};


document.getElementById("stop").onclick = () => {
    console.log("Stopping video stream");

    if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
    }

    if (stream) {
        stream.getTracks().forEach(t => t.stop());
    }

    if (ws) {
        ws.close();
    }

    console.log("Cleanup done");
};

</script>

</body>
</html>