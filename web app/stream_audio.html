<!doctype html>
<html>
  <body>
    <h3>Audio Stream Demo</h3>
    <button id="start">Start</button>
    <button id="stop">Stop</button>
    <script>
      let ws = null;
      let mediaRecorder = null;

      function createWS() {
        if (ws && ws.readyState === WebSocket.OPEN) return Promise.resolve(ws);
        return new Promise((resolve, reject) => {
          ws = new WebSocket("ws://127.0.0.1:8000/stream/audio/demo-session");
          ws.binaryType = "arraybuffer";
          ws.onopen = () => {
            console.log("WS open");
            resolve(ws);
          };
          ws.onmessage = (ev) => {
            console.log("Server:", ev.data);
          };
          ws.onerror = (e) => {
            console.error("WS error", e);
          };
          ws.onclose = () => {
            console.log("WS closed");
            ws = null; // important
          };
          // timeout if not open in 5s
          setTimeout(() => {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
              reject(new Error("WS open timeout"));
            }
          }, 5000);
        });
      }

      document.getElementById("start").onclick = async () => {
        try {
          await createWS(); // ensure ws open
        } catch (e) {
          console.error("Could not open WS:", e);
          return;
        }

        // get mic
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream, { mimeType: "audio/webm" });

          mediaRecorder.ondataavailable = (e) => {
            if (!e.data || e.data.size === 0) return;
            e.data.arrayBuffer().then(ab => {
              // check ws
              if (!ws || ws.readyState !== WebSocket.OPEN) {
                console.warn("WS not open; dropping chunk");
                return;
              }
              try {
                ws.send(ab);
              } catch (err) {
                console.error("Send failed:", err);
              }
            });
          };

          mediaRecorder.onstart = () => console.log("recorder started");
          mediaRecorder.start(500); // slice every 500ms

        } catch (err) {
          console.error("getUserMedia failed:", err);
        }
      };

      document.getElementById("stop").onclick = () => {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
          mediaRecorder.stream.getTracks().forEach(t => t.stop());
        }
        // flush signal (text)
        if (ws && ws.readyState === WebSocket.OPEN) {
          try { ws.send("flush"); } catch (e) { console.warn(e); }
          setTimeout(()=>{ if (ws) ws.close(); }, 300);
        } else {
          if (ws) ws.close();
        }
      };
    </script>
  </body>
</html>